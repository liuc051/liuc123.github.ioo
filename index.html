<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¥ç§˜å¯»å®å†’é™©</title>
    <style>
        /* å…¨å±€æ ·å¼ */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f8f0;
            color: #333;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        /* å¯¼èˆªæ ·å¼ */
        nav {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        nav a {
            margin: 0 10px;
            text-decoration: none;
            color: #2e7d32;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        nav a.active {
            color: #1b5e20;
            text-decoration: underline;
        }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 1rem;
            margin: 5px;
        }
        
        button:hover {
            background: #45a049;
        }
        
        /* é¡µé¢æ ·å¼ */
        .page {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .page.active {
            display: block;
        }
        
        .home h1 {
            color: #2e7d32;
            font-size: 2.5rem;
            margin-bottom: 30px;
        }
        
        .home p {
            font-size: 1.2rem;
            margin-bottom: 40px;
        }
        
        /* ç™»å½•é¡µé¢ */
        .login h2 {
            color: #2e7d32;
            font-size: 2rem;
            margin-bottom: 30px;
        }
        
        .login input {
            padding: 10px;
            margin-bottom: 20px;
            width: 80%;
            max-width: 300px;
            font-size: 1rem;
        }
        
        /* æ¸¸æˆåœºæ™¯ */
        .scene {
            display: none;
            animation: fadeIn 1s ease-in-out;
        }
        
        .scene.active {
            display: block;
        }
        
        .message {
            font-size: 1.2rem;
            margin: 20px 0;
        }
        
        .image-container {
            width: 100%;
            height: 300px;
            background-color: #eee;
            margin: 20px 0;
            border-radius: 5px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .panorama-container {
            height: 400px;
            position: relative;
        }
        
        .image-placeholder {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .location-marker {
            position: absolute;
            width: auto;
            min-width: 80px;
            padding: 5px 10px;
            height: auto;
            background-color: rgba(255, 0, 0, 0.7);
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s, background-color 0.3s;
            z-index: 10;
            font-size: 14px;
        }
        
        .options {
            margin: 20px 0;
        }
        
        .options button {
            margin: 5px;
            padding: 8px 16px;
        }
        
        .info {
            margin: 20px 0;
            font-size: 1.1rem;
        }
        
        /* æ’è¡Œæ¦œ */
        .ranking h2 {
            color: #2e7d32;
            margin-bottom: 30px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        th {
            background-color: #4CAF50;
            color: white;
        }
        
        /* éŸ³é¢‘æ§åˆ¶ */
        .audio-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 100;
        }
        
        .audio-btn {
            background-color: rgba(0, 0, 0, 0.5);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- éŸ³é¢‘æ§åˆ¶ï¼šåŒ¹é…audioæ–‡ä»¶å¤¹è·¯å¾„ï¼ˆä¸index.htmlåŒçº§ï¼‰ -->
    <div class="audio-controls">
        <button class="audio-btn" id="audioToggle">ğŸ”Š</button>
        <audio id="bgmGame" src="audio/game-bgm.mp3" loop></audio>
        <audio id="bgmSuccess" src="audio/success-bgm.mp3" loop></audio>
        <audio id="bgmFailure" src="audio/failure-bgm.mp3" loop></audio>
    </div>

    <div class="container">
        <nav id="navbar">
            <a href="#home" data-page="home">é¦–é¡µ</a> |
            <a href="#game" data-page="game">æ¸¸æˆ</a> |
            <a href="#ranking" data-page="ranking">æ’è¡Œæ¦œ</a> |
            <span id="userNav">
                <a href="#login" data-page="login">ç™»å½•</a>
            </span>
        </nav>

        <!-- é¦–é¡µ -->
        <div id="home" class="page active home">
            <h1>ç¥ç§˜å¯»å®å†’é™©</h1>
            <p>æ¬¢è¿æ¥åˆ°å¯»å®æ¸¸æˆï¼ç™»å½•åå³å¯å¼€å§‹ä½ çš„å†’é™©ä¹‹æ—…</p>
            <div id="homeButtons">
                <button onclick="navigateTo('login')">å¼€å§‹æ¸¸æˆ</button>
                <button onclick="navigateTo('ranking')">æŸ¥çœ‹æ’è¡Œæ¦œ</button>
            </div>
        </div>

        <!-- æ¸¸æˆé¡µé¢ -->
        <div id="game" class="page game">
            <div id="sceneContainer">
                <!-- å¼€å§‹åœºæ™¯ï¼šå›¾ç‰‡è·¯å¾„åŒ¹é…æ ¹ç›®å½•ä¸‹çš„letter.jpg -->
                <div id="scene-start" class="scene active">
                    <div class="message">ä½ æ”¶åˆ°ä¸€å°ç¥ç§˜ä¿¡ä»¶ï¼Œé‚€è¯·ä½ å‚åŠ ä¸€åœºå¯»å®å†’é™©ã€‚å‡†å¤‡å¥½å¼€å§‹ä½ çš„æ—…ç¨‹äº†å—ï¼Ÿ</div>
                    <div class="image-container">
                        <img src="letter.jpg" alt="ç¥ç§˜ä¿¡ä»¶" class="image-placeholder">
                    </div>
                    <button class="start-btn" onclick="startAdventure()">å¼€å§‹å†’é™©</button>
                </div>

                <!-- å…¨æ™¯åœ°å›¾åœºæ™¯ï¼šå›¾ç‰‡è·¯å¾„åŒ¹é…æ ¹ç›®å½•ä¸‹çš„panorama-map.jpg -->
                <div id="scene-panorama" class="scene">
                    <div class="message">è¿™æ˜¯å¯»å®ä¸–ç•Œçš„å…¨æ™¯åœ°å›¾ï¼Œç‚¹å‡»æ ‡è®°çš„åœ°ç‚¹å¼€å§‹æ¢ç´¢ï¼š</div>
                    <div class="image-container panorama-container">
                        <img src="panorama-map.jpg" alt="å¯»å®å…¨æ™¯åœ°å›¾" class="image-placeholder">
                        <div class="location-marker" style="top: 30%; left: 20%;" onclick="enterLocation('forest')">ä¸œè¾¹æ£®æ—</div>
                        <div class="location-marker" style="top: 65%; left: 50%;" onclick="enterLocation('cave')">å—è¾¹æ´ç©´</div>
                        <div class="location-marker" style="top: 15%; left: 65%;" onclick="enterLocation('mountain')">è¥¿è¾¹é«˜å±±</div>
                    </div>
                    <button onclick="restartGame()">è¿”å›å¼€å§‹</button>
                </div>

                <!-- æ¸¸æˆåœºæ™¯ï¼šå›¾ç‰‡è·¯å¾„åŠ¨æ€æ‹¼æ¥ï¼ŒåŒ¹é…æ ¹ç›®å½•ä¸‹çš„å¯¹åº”å›¾ç‰‡ -->
                <div id="scene-game" class="scene">
                    <div class="message" id="gameMessage"></div>
                    <div class="image-container">
                        <img id="gameImage" src="" alt="" class="image-placeholder">
                    </div>
                    <div class="options" id="gameOptions"></div>
                    <button onclick="returnToPanorama()" style="margin-top: 10px;">è¿”å›åœ°å›¾</button>
                </div>

                <!-- æˆåŠŸåœºæ™¯ï¼šå›¾ç‰‡è·¯å¾„åŒ¹é…æ ¹ç›®å½•ä¸‹çš„treasure.jpg -->
                <div id="scene-success" class="scene">
                    <div class="message">æ­å–œä½ ï¼ä½ æˆåŠŸæ‰¾åˆ°äº†ä¼ è¯´ä¸­çš„å®è—ï¼</div>
                    <div class="image-container">
                        <img src="treasure.jpg" alt="å®è—" class="image-placeholder">
                    </div>
                    <p>ä½ çš„å¾—åˆ†: <span id="successScore">0</span></p>
                    <p>ç”¨æ—¶: <span id="successTime">0:00</span></p>
                    <button onclick="restartGame()">å†æ¥ä¸€æ¬¡</button>
                </div>

                <!-- å¤±è´¥åœºæ™¯ï¼šå›¾ç‰‡è·¯å¾„åŠ¨æ€æ‹¼æ¥ï¼ŒåŒ¹é…æ ¹ç›®å½•ä¸‹çš„å¯¹åº”å¤±è´¥å›¾ç‰‡ -->
                <div id="scene-failure" class="scene">
                    <div class="message" id="failureMessage"></div>
                    <div class="image-container">
                        <img id="failureImage" src="" alt="" class="image-placeholder">
                    </div>
                    <p>æœ€ç»ˆå¾—åˆ†: <span id="failureScore">0</span></p>
                    <button onclick="restartGame()">é‡æ–°å°è¯•</button>
                </div>

                <!-- æ¸¸æˆä¿¡æ¯ -->
                <div class="info" id="gameInfo">
                    <p>åˆ†æ•°: <span id="gameScore">0</span></p>
                    <p>ç”¨æ—¶: <span id="gameTime">0:00</span></p>
                    <p>è¿›åº¦: <span id="gameProgress">0</span>%</p>
                </div>
            </div>
        </div>

        <!-- æ’è¡Œæ¦œé¡µé¢ -->
        <div id="ranking" class="page ranking">
            <h2>å¯»å®æ’è¡Œæ¦œ</h2>
            <table>
                <tr>
                    <th>æ’å</th>
                    <th>ç©å®¶</th>
                    <th>åˆ†æ•°</th>
                    <th>ç”¨æ—¶</th>
                </tr>
                <tbody id="rankingTableBody">
                    <!-- æ’è¡Œæ¦œæ•°æ®å°†é€šè¿‡JSåŠ¨æ€å¡«å…… -->
                </tbody>
            </table>
            <button onclick="navigateTo('home')">è¿”å›é¦–é¡µ</button>
        </div>

        <!-- ç™»å½•é¡µé¢ -->
        <div id="login" class="page login">
            <h2>ç™»å½•</h2>
            <input 
                id="usernameInput" 
                placeholder="è¯·è¾“å…¥ç”¨æˆ·å"
                onkeyup="if(event.key === 'Enter') handleLogin()"
            >
            <div id="loginError" style="color: red; margin: 10px 0;"></div>
            <button onclick="handleLogin()">ç™»å½•</button>
        </div>

        <!-- ä¸ªäººä¸­å¿ƒé¡µé¢ -->
        <div id="user" class="page user">
            <h2>ä¸ªäººä¸­å¿ƒ</h2>
            <p>ç”¨æˆ·å: <span id="userName"></span></p>
            <p>æœ€ä½³å¾—åˆ†: <span id="bestScore"></span></p>
            <p>æ¸¸æˆæ¬¡æ•°: <span id="gamesPlayed"></span></p>
            <button onclick="handleLogout()">é€€å‡ºç™»å½•</button>
            <button onclick="navigateTo('home')">è¿”å›é¦–é¡µ</button>
        </div>
    </div>

    <script>
        // çŠ¶æ€ç®¡ç†
        const state = {
            currentPage: 'home',
            currentScene: 'start',
            user: JSON.parse(localStorage.getItem('user')) || null,
            rankings: JSON.parse(localStorage.getItem('rankings')) || [],
            gameState: {
                score: 0,
                time: 0,
                timer: null,
                failureMessage: '',
                failureImage: '',
                exploredScenes: new Set(),
                progress: 0,
                totalScenes: 13 // åŒ¹é…æ‰€æœ‰å¯æ¢ç´¢åœºæ™¯æ•°é‡
            },
            audio: {
                isMuted: localStorage.getItem('audioMuted') === 'true',
                elements: {
                    game: document.getElementById('bgmGame'),
                    success: document.getElementById('bgmSuccess'),
                    failure: document.getElementById('bgmFailure')
                }
            }
        };

        // åœºæ™¯é…ç½®ï¼šå›¾ç‰‡è·¯å¾„ä¸æ ¹ç›®å½•ä¸‹çš„å›¾ç‰‡æ–‡ä»¶åå®Œå…¨åŒ¹é…ï¼ˆå‚è€ƒimage.pngä¸­çš„æ–‡ä»¶åˆ—è¡¨ï¼‰
        const scenes = {
            forest: {
                message: "ä½ åœ¨æ£®æ—æ·±å¤„å‘ç°äº†ä¸€ä¸ªå¤è€çš„çŸ³ç¢‘ï¼Œä¸Šé¢åˆ»ç€å¥‡æ€ªçš„ç¬¦å·...",
                image: "stone-tablet.jpg", // æ ¹ç›®å½•ä¸‹å­˜åœ¨è¯¥æ–‡ä»¶
                options: [
                    { text: "å°è¯•ç ´è¯‘ç¬¦å·", nextStep: "decipher" },
                    { text: "å¿½ç•¥ç¬¦å·ç»§ç»­å‰è¿›", nextStep: "forest-path" }
                ]
            },
            cave: {
                message: "æ´ç©´æ·±å¤„æœ‰ä¸€ä¸ªåœ°ä¸‹æ¹–ï¼Œæ¹–ä¸­æœ‰ä¸€è‰˜å°èˆ¹...",
                image: "underground-lake.jpg", // æ ¹ç›®å½•ä¸‹å­˜åœ¨è¯¥æ–‡ä»¶
                options: [
                    { text: "ä¹˜èˆ¹æ¢ç´¢æ¹–ä¸­å¿ƒ", nextStep: "boat-ride" },
                    { text: "æ²¿æ¹–å²¸å¯»æ‰¾çº¿ç´¢", nextStep: "lake-shore" }
                ]
            },
            mountain: {
                message: "å±±é¡¶æœ‰ä¸€åº§åºŸå¼ƒçš„å¤©æ–‡å°ï¼Œé‡Œé¢ä¼¼ä¹æœ‰ä»€ä¹ˆä¸œè¥¿...",
                image: "observatory.jpg", // æ ¹ç›®å½•ä¸‹å­˜åœ¨è¯¥æ–‡ä»¶
                options: [
                    { text: "æ£€æŸ¥æœ›è¿œé•œ", nextStep: "telescope" },
                    { text: "æœç´¢æˆ¿é—´è§’è½", nextStep: "observatory-search" }
                ]
            },
            // æ£®æ—å­åœºæ™¯
            'forest-path': {
                message: "ä½ æ²¿ç€å°è·¯æ¥åˆ°ä¸€ä¸ªç€‘å¸ƒå‰ï¼Œå‘ç°ç€‘å¸ƒåé¢æœ‰ä¸ªæ´å£ï¼",
                image: "waterfall-cave.jpg", // æ ¹ç›®å½•ä¸‹å­˜åœ¨è¯¥æ–‡ä»¶
                options: [
                    { text: "è¿›å…¥ç€‘å¸ƒåçš„æ´ç©´", nextStep: "treasure-cave" }
                ]
            },
            'decipher': {
                message: "ç¬¦å·æŒ‡å¼•ä½ æ‰¾åˆ°äº†ä¸€ä¸ªéšè—çš„é€šé“ï¼",
                image: "hidden-passage.jpg", // æ ¹ç›®å½•ä¸‹å­˜åœ¨è¯¥æ–‡ä»¶
                options: [
                    { text: "è¿›å…¥é€šé“", nextStep: "treasure-passage" }
                ]
            },
            // æ´ç©´å­åœºæ™¯
            'boat-ride': {
                message: "æ¹–ä¸­å¿ƒæœ‰ä¸ªå°å²›ï¼Œå²›ä¸Šæœ‰ä¸ªå®ç®±ï¼",
                image: "island-treasure.jpg", // æ ¹ç›®å½•ä¸‹å­˜åœ¨è¯¥æ–‡ä»¶
                options: [
                    { text: "æ‰“å¼€å®ç®±", nextStep: "open-treasure" }
                ]
            },
            'lake-shore': {
                message: "ä½ åœ¨æ¹–å²¸å²©çŸ³ä¸‹å‘ç°äº†ä¸€æŠŠé’¥åŒ™ï¼Œä¼¼ä¹èƒ½æ‰“å¼€æŸä¸ªé—¨...",
                image: "lake-key.jpg", // æ ¹ç›®å½•ä¸‹å­˜åœ¨è¯¥æ–‡ä»¶
                options: [
                    { text: "è¿”å›ä¹˜èˆ¹æ¢ç´¢æ¹–ä¸­å¿ƒ", nextStep: "boat-ride" }
                ]
            },
            // é«˜å±±å­åœºæ™¯
            'telescope': {
                message: "æœ›è¿œé•œæŒ‡å‘å±±è°·ä¸­çš„ä¸€å—å·¨çŸ³ï¼Œçœ‹èµ·æ¥å¾ˆä¸å¯»å¸¸...",
                image: "telescope-view.jpg", // æ ¹ç›®å½•ä¸‹å­˜åœ¨è¯¥æ–‡ä»¶
                options: [
                    { text: "å‰å¾€å±±è°·æŸ¥çœ‹å·¨çŸ³", nextStep: "mountain-valley" }
                ]
            },
            'observatory-search': {
                message: "ä½ åœ¨è§’è½æ‰¾åˆ°ä¸€å¼ æ—¥è®°ï¼Œè®°å½•ç€å·¨çŸ³çš„ç§˜å¯†...",
                image: "observatory-diary.jpg", // æ ¹ç›®å½•ä¸‹å­˜åœ¨è¯¥æ–‡ä»¶
                options: [
                    { text: "å‰å¾€å±±è°·æŸ¥çœ‹å·¨çŸ³", nextStep: "mountain-valley" }
                ]
            },
            // å®è—åœºæ™¯ï¼ˆæ— éœ€é¢å¤–å›¾ç‰‡ï¼Œå¤ç”¨successåœºæ™¯çš„treasure.jpgï¼‰
            'treasure-cave': { isTreasure: true },
            'treasure-passage': { isTreasure: true },
            'open-treasure': { isTreasure: true },
            'mountain-valley': { isTreasure: true }
        };

        // å¤±è´¥åœºæ™¯é…ç½®ï¼šå›¾ç‰‡è·¯å¾„ä¸æ ¹ç›®å½•ä¸‹çš„å¤±è´¥å›¾ç‰‡å®Œå…¨åŒ¹é…ï¼ˆå‚è€ƒimage.pngä¸­çš„æ–‡ä»¶åˆ—è¡¨ï¼‰
        const failures = {
            forest: {
                message: "ä½ åœ¨æ£®æ—ä¸­è¿·å¤±äº†æ–¹å‘ï¼Œè¢«é‡å…½åŒ…å›´äº†ï¼",
                image: "forest-failure.jpg" // æ ¹ç›®å½•ä¸‹å­˜åœ¨è¯¥æ–‡ä»¶
            },
            cave: {
                message: "æ´ç©´çªç„¶å¡Œæ–¹ï¼Œä½ è¢«å›°ä½äº†ï¼",
                image: "cave-failure.jpg" // æ ¹ç›®å½•ä¸‹å­˜åœ¨è¯¥æ–‡ä»¶
            },
            mountain: {
                message: "å±±ä¸Šå‘ç”Ÿé›ªå´©ï¼Œä½ æ²¡èƒ½èº²è¿‡...",
                image: "mountain-failure.jpg" // æ ¹ç›®å½•ä¸‹å­˜åœ¨è¯¥æ–‡ä»¶
            },
            "forest-path": {
                message: "ä½ å¿½ç•¥ç¬¦å·åèµ°é”™æ–¹å‘ï¼Œé™·å…¥æ»¡æ˜¯è†æ£˜çš„çŒæœ¨ä¸›ï¼",
                image: "bush-failure.jpg" // æ ¹ç›®å½•ä¸‹å­˜åœ¨è¯¥æ–‡ä»¶
            },
            "decipher": {
                message: "ä½ è¯¯è§£äº†ç¬¦å·çš„æ„æ€ï¼Œé—¯å…¥äº†æ¯’è›‡çš„å·¢ç©´ï¼",
                image: "snake-failure.jpg" // æ ¹ç›®å½•ä¸‹å­˜åœ¨è¯¥æ–‡ä»¶
            },
            "boat-ride": {
                message: "èˆ¹æ¼æ°´äº†ï¼Œä½ æ‰è¿›äº†å†°å†·çš„æ¹–æ°´ä¸­ï¼",
                image: "boat-failure.jpg" // æ ¹ç›®å½•ä¸‹å­˜åœ¨è¯¥æ–‡ä»¶
            },
            "lake-shore": {
                message: "ä½ åœ¨æ¹–å²¸è¸©åˆ°æ¹¿æ»‘çš„é’è‹”ï¼Œæ‘”å…¥æ·±æ°´åŒºï¼",
                image: "lake-failure.jpg" // æ ¹ç›®å½•ä¸‹å­˜åœ¨è¯¥æ–‡ä»¶
            },
            "telescope": {
                message: "æœ›è¿œé•œé•œç‰‡æ¨¡ç³Šï¼Œä½ çœ‹é”™äº†å±±è°·æ–¹å‘ï¼Œèµ°åˆ°äº†æ‚¬å´–è¾¹ç¼˜ï¼",
                image: "cliff-failure.jpg" // æ ¹ç›®å½•ä¸‹å­˜åœ¨è¯¥æ–‡ä»¶
            },
            "observatory-search": {
                message: "ä½ ç¢°å€’äº†ç”Ÿé”ˆçš„ä»ªå™¨ï¼Œè¢«æ‰è½çš„é›¶ä»¶ç ¸ä¼¤ï¼",
                image: "instrument-failure.jpg" // æ ¹ç›®å½•ä¸‹å­˜åœ¨è¯¥æ–‡ä»¶
            },
            // é»˜è®¤å¤±è´¥å›¾ç‰‡ï¼ˆé˜²æ­¢é—æ¼ï¼‰
            default: {
                message: "æ¢é™©è¿‡ç¨‹ä¸­é‡åˆ°æ„å¤–ï¼ŒæŒ‘æˆ˜å¤±è´¥ï¼",
                image: "failure.jpg" // æ ¹ç›®å½•ä¸‹å­˜åœ¨è¯¥æ–‡ä»¶
            }
        };

        // å¯¼èˆªåŠŸèƒ½
        function navigateTo(page) {
            // æœªç™»å½•æ—¶è®¿é—®æ¸¸æˆ/ä¸ªäººä¸­å¿ƒï¼Œè‡ªåŠ¨è·³è½¬ç™»å½•é¡µ
            if ((page === 'game' || page === 'user') && !state.user) {
                page = 'login';
            }

            // æ›´æ–°é¡µé¢æ˜¾ç¤º
            document.querySelectorAll('.page').forEach(el => {
                el.classList.remove('active');
            });
            document.getElementById(page).classList.add('active');
            state.currentPage = page;

            // æ›´æ–°å¯¼èˆªæ æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('nav a').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('data-page') === page) {
                    link.classList.add('active');
                }
            });

            // åŒæ­¥æ›´æ–°éŸ³é¢‘
            updateAudioForPage();
        }

        // åˆå§‹åŒ–å¯¼èˆªç‚¹å‡»äº‹ä»¶
        document.querySelectorAll('nav a').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const page = this.getAttribute('data-page');
                navigateTo(page);
            });
        });

        // ç”¨æˆ·ç™»å½•/é€€å‡ºåŠŸèƒ½
        function handleLogin() {
            const username = document.getElementById('usernameInput').value.trim();
            const loginError = document.getElementById('loginError');
            
            // æ¸…ç©ºé”™è¯¯æç¤º
            loginError.textContent = '';
            
            if (username) {
                // è¯»å–æœ¬åœ°å­˜å‚¨çš„ç”¨æˆ·æ•°æ®
                const existingUser = JSON.parse(localStorage.getItem('user'));
                if (existingUser && existingUser.username === username) {
                    state.user = existingUser;
                } else {
                    // æ–°ç”¨æˆ·åˆå§‹åŒ–æ•°æ®
                    state.user = { username, bestScore: 0, gamesPlayed: 0 };
                }
                // ä¿å­˜ç”¨æˆ·æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem('user', JSON.stringify(state.user));
                updateUserNav();
                updateHomeButtons();
                navigateTo('home');
                // æ¸…ç©ºè¾“å…¥æ¡†
                document.getElementById('usernameInput').value = '';
            } else {
                // æ˜¾ç¤ºé”™è¯¯æç¤º
                loginError.textContent = 'è¯·è¾“å…¥ç”¨æˆ·å';
            }
        }

        function handleLogout() {
            state.user = null;
            localStorage.removeItem('user');
            updateUserNav();
            updateHomeButtons();
            navigateTo('home');
        }

        // æ›´æ–°å¯¼èˆªæ ç”¨æˆ·å…¥å£ï¼ˆç™»å½•/ä¸ªäººä¸­å¿ƒåˆ‡æ¢ï¼‰
        function updateUserNav() {
            const userNav = document.getElementById('userNav');
            if (state.user) {
                userNav.innerHTML = `
                    <a href="#user" data-page="user">ä¸ªäººä¸­å¿ƒ</a> |
                    <button onclick="handleLogout()">é€€å‡º</button>
                `;
                // åŒæ­¥æ›´æ–°ä¸ªäººä¸­å¿ƒæ•°æ®
                document.getElementById('userName').textContent = state.user.username;
                document.getElementById('bestScore').textContent = state.user.bestScore;
                document.getElementById('gamesPlayed').textContent = state.user.gamesPlayed;
                
                // ä¸ºåŠ¨æ€ç”Ÿæˆçš„ä¸ªäººä¸­å¿ƒé“¾æ¥æ·»åŠ å¯¼èˆªäº‹ä»¶
                const userLink = userNav.querySelector('a[data-page="user"]');
                if (userLink) {
                    userLink.addEventListener('click', function(e) {
                        e.preventDefault();
                        const page = this.getAttribute('data-page');
                        navigateTo(page);
                    });
                }
            } else {
                userNav.innerHTML = `<a href="#login" data-page="login">ç™»å½•</a>`;
                
                // ä¸ºåŠ¨æ€ç”Ÿæˆçš„ç™»å½•é“¾æ¥æ·»åŠ å¯¼èˆªäº‹ä»¶
                const loginLink = userNav.querySelector('a[data-page="login"]');
                if (loginLink) {
                    loginLink.addEventListener('click', function(e) {
                        e.preventDefault();
                        const page = this.getAttribute('data-page');
                        navigateTo(page);
                    });
                }
            }
        }

        // æ›´æ–°é¦–é¡µæŒ‰é’®ï¼ˆæœªç™»å½•â†’"å¼€å§‹æ¸¸æˆ"è·³è½¬ç™»å½•ï¼Œå·²ç™»å½•â†’"ç»§ç»­å†’é™©"è·³è½¬æ¸¸æˆï¼‰
        function updateHomeButtons() {
            const homeButtons = document.getElementById('homeButtons');
            if (state.user) {
                homeButtons.innerHTML = `
                    <button onclick="navigateTo('game')">ç»§ç»­å†’é™©</button>
                    <button onclick="navigateTo('ranking')">æŸ¥çœ‹æ’è¡Œæ¦œ</button>
                `;
            } else {
                homeButtons.innerHTML = `
                    <button onclick="navigateTo('login')">å¼€å§‹æ¸¸æˆ</button>
                    <button onclick="navigateTo('ranking')">æŸ¥çœ‹æ’è¡Œæ¦œ</button>
                `;
            }
        }

        // æ¸¸æˆæ ¸å¿ƒåŠŸèƒ½
        function startAdventure() {
            showScene('panorama');
            startTimer();
        }

        // åˆ‡æ¢æ¸¸æˆåœºæ™¯
        function showScene(sceneName) {
            // éšè—æ‰€æœ‰åœºæ™¯
            document.querySelectorAll('.scene').forEach(scene => {
                scene.classList.remove('active');
            });
            // æ˜¾ç¤ºç›®æ ‡åœºæ™¯
            document.getElementById(`scene-${sceneName}`).classList.add('active');
            state.currentScene = sceneName;
            
            // æ§åˆ¶æ¸¸æˆä¿¡æ¯æ˜¾ç¤ºï¼ˆå¼€å§‹/æˆåŠŸ/å¤±è´¥åœºæ™¯éšè—ä¿¡æ¯æ ï¼‰
            document.getElementById('gameInfo').style.display = 
                (sceneName === 'start' || sceneName === 'success' || sceneName === 'failure') ? 'none' : 'block';
                
            // åŒæ­¥æ›´æ–°éŸ³é¢‘
            updateAudioForScene();
        }

        // è¿›å…¥å…·ä½“æ¢ç´¢åœºæ™¯ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰
        function enterLocation(location) {
            // è®°å½•å·²æ¢ç´¢åœºæ™¯ï¼Œæ›´æ–°è¿›åº¦
            state.gameState.exploredScenes.add(location);
            updateGameProgress();
            
            // 30%æ¦‚ç‡è§¦å‘å¤±è´¥ï¼ˆå®è—åœºæ™¯ä¸è§¦å‘å¤±è´¥ï¼‰
            if (Math.random() < 0.3 && !scenes[location]?.isTreasure) {
                const failure = failures[location] || failures.default;
                
                // å¤±è´¥æ—¶ä¿ç•™70%å½“å‰åˆ†æ•°
                state.gameState.score = Math.round(state.gameState.score * 0.7);
                state.gameState.failureMessage = failure.message;
                state.gameState.failureImage = failure.image;
                
                // æ›´æ–°å¤±è´¥é¡µé¢æ•°æ®ï¼ˆå›¾ç‰‡è·¯å¾„ç›´æ¥ä½¿ç”¨æ ¹ç›®å½•æ–‡ä»¶ï¼‰
                document.getElementById('failureMessage').textContent = failure.message;
                document.getElementById('failureImage').src = failure.image;
                document.getElementById('failureScore').textContent = state.gameState.score;
                
                // åœæ­¢è®¡æ—¶ï¼Œæ˜¾ç¤ºå¤±è´¥åœºæ™¯
                stopTimer();
                showScene('failure');
                return;
            }
            
            // å¤„ç†å®è—åœºæ™¯ï¼ˆæˆåŠŸé€»è¾‘ï¼‰
            if (scenes[location]?.isTreasure) {
                // è®¡ç®—æœ€ç»ˆå¾—åˆ†ï¼šåŸºç¡€åˆ†100 + è¿›åº¦åˆ† + æ—¶é—´å¥–åŠ±ï¼ˆæ—¶é—´è¶ŠçŸ­å¥–åŠ±è¶Šé«˜ï¼‰
                const baseScore = 100;
                const progressScore = state.gameState.progress;
                const timeBonus = Math.max(0, 50 - Math.min(50, Math.floor(state.gameState.time / 10)));
                state.gameState.score += baseScore + progressScore + timeBonus;
                
                // æ›´æ–°æˆåŠŸé¡µé¢æ•°æ®
                document.getElementById('successScore').textContent = state.gameState.score;
                document.getElementById('successTime').textContent = formatTime(state.gameState.time);
                
                // ç™»å½•ç”¨æˆ·ä¿å­˜åˆ†æ•°åˆ°æ’è¡Œæ¦œ
                if (state.user) {
                    saveScore(state.gameState.score, state.gameState.time);
                }
                
                // åœæ­¢è®¡æ—¶ï¼Œæ˜¾ç¤ºæˆåŠŸåœºæ™¯
                stopTimer();
                showScene('success');
                return;
            }
            
            // å¤„ç†æ™®é€šæ¢ç´¢åœºæ™¯
            const scene = scenes[location];
            document.getElementById('gameMessage').textContent = scene.message;
            // å›¾ç‰‡è·¯å¾„ç›´æ¥ä½¿ç”¨æ ¹ç›®å½•æ–‡ä»¶ï¼ˆæ— éœ€é¢å¤–è·¯å¾„æ‹¼æ¥ï¼‰
            document.getElementById('gameImage').src = scene.image;
            
            // ç”Ÿæˆåœºæ™¯é€‰é¡¹æŒ‰é’®
            const optionsContainer = document.getElementById('gameOptions');
            optionsContainer.innerHTML = '';
            scene.options.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option.text;
                button.onclick = () => handleOption(option.nextStep);
                optionsContainer.appendChild(button);
            });
            
            // æ¢ç´¢å¾—åˆ†ï¼šåœºæ™¯å±‚çº§è¶Šæ·±ï¼ˆå¦‚"forest-path"æ¯”"forest"æ·±1çº§ï¼‰ï¼Œå¾—åˆ†è¶Šé«˜
            const sceneDepth = location.split('-').length;
            const sceneScore = 10 * sceneDepth;
            state.gameState.score += sceneScore;
            document.getElementById('gameScore').textContent = state.gameState.score;
            
            // æ˜¾ç¤ºå½“å‰åœºæ™¯
            showScene('game');
        }

        // å¤„ç†åœºæ™¯é€‰é¡¹ç‚¹å‡»
        function handleOption(nextStep) {
            enterLocation(nextStep);
        }

        // è¿”å›å…¨æ™¯åœ°å›¾
        function returnToPanorama() {
            showScene('panorama');
        }

        // é‡æ–°å¼€å§‹æ¸¸æˆï¼ˆé‡ç½®çŠ¶æ€ï¼‰
        function restartGame() {
            stopTimer();
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            state.gameState = {
                score: 0,
                time: 0,
                timer: null,
                failureMessage: '',
                failureImage: '',
                exploredScenes: new Set(),
                progress: 0,
                totalScenes: 13
            };
            
            // é‡ç½®UIæ˜¾ç¤º
            document.getElementById('gameScore').textContent = '0';
            document.getElementById('gameTime').textContent = '0:00';
            document.getElementById('gameProgress').textContent = '0';
            
            // å›åˆ°å¼€å§‹åœºæ™¯
            showScene('start');
        }

        // è®¡æ—¶å™¨åŠŸèƒ½
        function startTimer() {
            stopTimer(); // é˜²æ­¢é‡å¤è®¡æ—¶
            state.gameState.timer = setInterval(() => {
                state.gameState.time++;
                document.getElementById('gameTime').textContent = formatTime(state.gameState.time);
            }, 1000);
        }

        function stopTimer() {
            if (state.gameState.timer) {
                clearInterval(state.gameState.timer);
                state.gameState.timer = null;
            }
        }

        // æ ¼å¼åŒ–æ—¶é—´ï¼ˆç§’â†’åˆ†:ç§’ï¼Œå¦‚65ç§’â†’1:05ï¼‰
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // æ›´æ–°æ¸¸æˆè¿›åº¦ï¼ˆå·²æ¢ç´¢åœºæ™¯æ•°/æ€»åœºæ™¯æ•° * 100ï¼‰
        function updateGameProgress() {
            state.gameState.progress = Math.round(
                (state.gameState.exploredScenes.size / state.gameState.totalScenes) * 100
            );
            document.getElementById('gameProgress').textContent = state.gameState.progress;
        }

        // æ’è¡Œæ¦œåŠŸèƒ½ï¼ˆä¿å­˜åˆ†æ•°å¹¶æ’åºï¼‰
        function saveScore(score, time) {
            if (!state.user) return;
            
            // æ›´æ–°ç”¨æˆ·æ¸¸æˆæ¬¡æ•°å’Œæœ€ä½³å¾—åˆ†
            state.user.gamesPlayed++;
            if (score > state.user.bestScore) {
                state.user.bestScore = score;
            }
            
            // æ·»åŠ æ–°åˆ†æ•°åˆ°æ’è¡Œæ¦œ
            state.rankings.push({
                username: state.user.username,
                score,
                time,
                date: new Date().toISOString() // è®°å½•æ—¶é—´ï¼ˆç”¨äºåç»­æ‰©å±•ï¼‰
            });
            
            // æ’è¡Œæ¦œæ’åºï¼šå…ˆæŒ‰åˆ†æ•°é™åºï¼Œåˆ†æ•°ç›¸åŒæŒ‰æ—¶é—´å‡åº
            state.rankings.sort((a, b) => b.score - a.score || a.time - b.time);
            // åªä¿ç•™å‰10å
            if (state.rankings.length > 10) {
                state.rankings = state.rankings.slice(0, 10);
            }
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆåˆ·æ–°é¡µé¢ä¸ä¸¢å¤±æ•°æ®ï¼‰
            localStorage.setItem('user', JSON.stringify(state.user));
            localStorage.setItem('rankings', JSON.stringify(state.rankings));
            
            // åŒæ­¥æ›´æ–°UI
            updateUserNav();
            renderRankings();
        }

        // æ¸²æŸ“æ’è¡Œæ¦œè¡¨æ ¼
        function renderRankings() {
            const tableBody = document.getElementById('rankingTableBody');
            tableBody.innerHTML = '';
            
            // æ— æ•°æ®æ—¶æ˜¾ç¤ºæç¤º
            if (state.rankings.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = '<td colspan="4" style="text-align:center;">æš‚æ— æ’è¡Œæ¦œæ•°æ®</td>';
                tableBody.appendChild(emptyRow);
                return;
            }
            
            // æœ‰æ•°æ®æ—¶æ¸²æŸ“æ¯è¡Œ
            state.rankings.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.username}</td>
                    <td>${item.score}</td>
                    <td>${formatTime(item.time)}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // éŸ³é¢‘æ§åˆ¶åŠŸèƒ½
        function toggleMute() {
            state.audio.isMuted = !state.audio.isMuted;
            // æ›´æ–°éŸ³é¢‘æŒ‰é’®å›¾æ ‡
            document.getElementById('audioToggle').textContent = state.audio.isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
            // åŒæ­¥æ‰€æœ‰éŸ³é¢‘çš„é™éŸ³çŠ¶æ€
            updateAudioState();
            // ä¿å­˜é™éŸ³çŠ¶æ€åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆåˆ·æ–°é¡µé¢ä¿ç•™ï¼‰
            localStorage.setItem('audioMuted', state.audio.isMuted);
        }

        // æ›´æ–°æ‰€æœ‰éŸ³é¢‘çš„é™éŸ³çŠ¶æ€
        function updateAudioState() {
            Object.values(state.audio.elements).forEach(audio => {
                audio.muted = state.audio.isMuted;
            });
        }

        // åœæ­¢æ‰€æœ‰éŸ³é¢‘æ’­æ”¾ï¼ˆåœºæ™¯åˆ‡æ¢æ—¶è°ƒç”¨ï¼‰
        function stopAllAudio() {
            Object.values(state.audio.elements).forEach(audio => {
                audio.pause();
                audio.currentTime = 0; // é‡ç½®æ’­æ”¾è¿›åº¦åˆ°å¼€å¤´
            });
        }

        // æ ¹æ®å½“å‰é¡µé¢æ›´æ–°éŸ³é¢‘
        function updateAudioForPage() {
            if (state.currentPage !== 'game') {
                stopAllAudio();
                return;
            }
            updateAudioForScene();
        }

        // æ ¹æ®å½“å‰æ¸¸æˆåœºæ™¯æ›´æ–°éŸ³é¢‘ï¼ˆæˆåŠŸâ†’èƒœåˆ©éŸ³ä¹ï¼Œå¤±è´¥â†’å¤±è´¥éŸ³ä¹ï¼Œå…¶ä»–â†’æ¸¸æˆèƒŒæ™¯éŸ³ï¼‰
        function updateAudioForScene() {
            stopAllAudio();
            
            // éæ¸¸æˆé¡µé¢æˆ–é™éŸ³çŠ¶æ€ï¼Œä¸æ’­æ”¾éŸ³é¢‘
            if (state.currentPage !== 'game' || state.audio.isMuted) return;
            
            if (state.currentScene === 'success') {
                state.audio.elements.success.play().catch(e => console.log('èƒœåˆ©éŸ³ä¹æ’­æ”¾å¤±è´¥:', e));
            } else if (state.currentScene === 'failure') {
                state.audio.elements.failure.play().catch(e => console.log('å¤±è´¥éŸ³ä¹æ’­æ”¾å¤±è´¥:', e));
            } else if (state.currentScene === 'game' || state.currentScene === 'panorama') {
                state.audio.elements.game.play().catch(e => console.log('æ¸¸æˆèƒŒæ™¯éŸ³ä¹æ’­æ”¾å¤±è´¥:', e));
            }
        }

        // é¡µé¢åˆå§‹åŒ–ï¼ˆåŠ è½½å®Œæˆåæ‰§è¡Œï¼‰
        function init() {
            // åˆå§‹åŒ–éŸ³é¢‘æŒ‰é’®äº‹ä»¶
            document.getElementById('audioToggle').textContent = state.audio.isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
            document.getElementById('audioToggle').addEventListener('click', toggleMute);
            updateAudioState();
            
            // åˆå§‹åŒ–ç”¨æˆ·å¯¼èˆªå’Œé¦–é¡µæŒ‰é’®
            updateUserNav();
            updateHomeButtons();
            
            // åˆå§‹åŒ–æ’è¡Œæ¦œ
            renderRankings();
            
            // å¤„ç†URLå“ˆå¸Œï¼ˆå¦‚æ‰“å¼€é¡µé¢æ—¶URLå«#gameï¼Œç›´æ¥è·³è½¬åˆ°æ¸¸æˆé¡µï¼‰
            const hash = window.location.hash.substring(1);
            if (hash && document.getElementById(hash)) {
                navigateTo(hash);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œåˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>